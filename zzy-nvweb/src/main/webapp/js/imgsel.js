!function(e){e.imgAreaSelect={onKeyPress:null},e.imgAreaSelect.init=function(t,o){function i(e){return e+K.left-j.left}function n(e){return e+K.top-j.top}function s(e){return e-K.left+j.left}function d(e){return e-K.top+j.top}function r(e){return e.pageX-j.left}function a(e){return e.pageY-j.top}function l(){return{x1:ae.round(fe.x1*he),y1:ae.round(fe.y1*ue),x2:ae.round(fe.x2*he),y2:ae.round(fe.y2*ue),width:ae.round(fe.x2*he)-ae.round(fe.x1*he),height:ae.round(fe.y2*ue)-ae.round(fe.y1*ue)}}function c(){for(L=Z;L.length&&!L.is("body");)!isNaN(L.css("z-index"))&&L.css("z-index")>le&&(le=L.css("z-index")),"fixed"==L.css("position")&&(ce="fixed"),L=L.parent();isNaN(o.zIndex)||(le=o.zIndex)}function h(){K={left:ae.round(Z.offset().left),top:ae.round(Z.offset().top)},I=Z.width(),E=Z.height(),"1.3.2"==e().jquery&&e.browser.safari&&"fixed"==ce&&(K.top+=ae.max(document.documentElement.scrollTop,e("body").scrollTop()),K.left+=ae.max(document.documentElement.scrollLeft,e("body").scrollLeft())),j=e.inArray(T.css("position"),["absolute","relative"])!=-1?{left:ae.round(T.offset().left)-T.scrollLeft(),top:ae.round(T.offset().top)-T.scrollTop()}:"fixed"==ce?{left:e(document).scrollLeft(),top:e(document).scrollTop()}:{left:0,top:0},N=i(0),O=n(0)}function u(t){U&&($.css({left:i(fe.x1)+"px",top:n(fe.y1)+"px",width:fe.width+"px",height:fe.height+"px"}),_.add(ee).add(te).css({left:"0px",top:"0px",width:ae.max(fe.width-2*o.borderWidth,0)+"px",height:ae.max(fe.height-2*o.borderWidth,0)+"px"}),ee.css({borderStyle:"solid",borderColor:o.borderColor1}),te.css({borderStyle:"dashed",borderColor:o.borderColor2}),ee.add(te).css({opacity:o.borderOpacity}),oe.css({left:N+"px",top:O+"px",width:fe.x1+"px",height:E+"px"}),ie.css({left:N+fe.x1+"px",top:O+"px",width:fe.width+"px",height:fe.y1+"px"}),ne.css({left:N+fe.x2+"px",top:O+"px",width:I-fe.x2+"px",height:E+"px"}),se.css({left:N+fe.x1+"px",top:O+fe.y2+"px",width:fe.width+"px",height:E-fe.y2+"px"}),re.length&&(re[1].css({left:fe.width-P+"px"}),re[2].css({left:fe.width-P+"px",top:fe.height-P+"px"}),re[3].css({top:fe.height-P+"px"}),8==re.length&&(re[4].css({left:(fe.width-P)/2+"px"}),re[5].css({left:fe.width-P+"px",top:(fe.height-P)/2+"px"}),re[6].css({left:(fe.width-P)/2+"px",top:fe.height-P+"px"}),re[7].css({top:(fe.height-P)/2+"px"}))),t!==!1&&(e.imgAreaSelect.keyPress!=ge&&e(document).unbind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress),o.keys&&e(document).bind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress=ge)),e.browser.msie&&1==o.borderWidth&&o.borderOpacity<1&&(ee.add(te).css("margin","0"),setTimeout(function(){ee.add(te).css("margin","auto")},0)))}function m(e){J||(h(),J=!0,$.one("mouseout",function(){J=!1})),F=s(r(e))-fe.x1,G=d(a(e))-fe.y1,xe=[],o.resizable&&(G<=me?xe[pe]="n":G>=fe.height-me&&(xe[pe]="s"),F<=me?xe[be]="w":F>=fe.width-me&&(xe[be]="e")),$.css("cursor",xe.length?xe.join("")+"-resize":o.movable?"move":""),H&&H.toggle()}function x(i){xe=[],e("body").css("cursor",""),(o.autoHide||fe.width*fe.height==0)&&$.add(ye).hide(),o.onSelectEnd(t,l()),e(document).unbind("mousemove",g),$.mousemove(m)}function p(s){return 1==s.which&&(h(),o.resizable&&xe.length>0?(e("body").css("cursor",xe.join("")+"-resize"),M=i(fe["w"==xe[be]?"x2":"x1"]),X=n(fe["n"==xe[pe]?"y2":"y1"]),e(document).mousemove(g).one("mouseup",x),$.unbind("mousemove",m)):o.movable?(B=N+fe.x1-r(s),R=O+fe.y1-a(s),$.unbind("mousemove",m),e(document).mousemove(v).one("mouseup",function(){o.onSelectEnd(t,l()),e(document).unbind("mousemove",v),$.mousemove(m)})):Z.mousedown(s),!1)}function b(){Q=ae.max(N,ae.min(N+I,M+ae.abs(Y-X)*D*(Q<M?-1:1))),Y=ae.round(ae.max(O,ae.min(O+E,X+ae.abs(Q-M)/D*(Y<X?-1:1)))),Q=ae.round(Q)}function f(){Y=ae.max(O,ae.min(O+E,X+ae.abs(Q-M)/D*(Y<X?-1:1))),Q=ae.round(ae.max(N,ae.min(N+I,M+ae.abs(Y-X)*D*(Q<M?-1:1)))),Y=ae.round(Y)}function y(){o.minWidth&&ae.abs(Q-M)<o.minWidth&&(Q=M-o.minWidth*(Q<M?1:-1),Q<N?M=N+o.minWidth:Q>N+I&&(M=N+I-o.minWidth)),o.minHeight&&ae.abs(Y-X)<o.minHeight&&(Y=X-o.minHeight*(Y<X?1:-1),Y<O?X=O+o.minHeight:Y>O+E&&(X=O+E-o.minHeight)),Q=ae.max(N,ae.min(Q,N+I)),Y=ae.max(O,ae.min(Y,O+E)),D&&(ae.abs(Q-M)/D>ae.abs(Y-X)?f():b()),o.maxWidth&&ae.abs(Q-M)>o.maxWidth&&(Q=M-o.maxWidth*(Q<M?1:-1),D&&f()),o.maxHeight&&ae.abs(Y-X)>o.maxHeight&&(Y=X-o.maxHeight*(Y<X?1:-1),D&&b()),fe={x1:s(ae.min(M,Q)),x2:s(ae.max(M,Q)),y1:d(ae.min(X,Y)),y2:d(ae.max(X,Y)),width:ae.abs(Q-M),height:ae.abs(Y-X)},u(),o.onSelectChange(t,l())}function g(e){return Q=!xe.length||xe[be]||D?r(e):i(fe.x2),Y=!xe.length||xe[pe]||D?a(e):n(fe.y2),y(),!1}function w(i,n){Q=(M=i)+fe.width,Y=(X=n)+fe.height,fe=e.extend(fe,{x1:s(M),y1:d(X),x2:s(Q),y2:d(Y)}),u(),o.onSelectChange(t,l())}function v(e){return M=ae.max(N,ae.min(B+r(e),N+I-fe.width)),X=ae.max(O,ae.min(R+a(e),O+E-fe.height)),w(M,X),e.preventDefault(),!1}function S(i){h(),Q=M,Y=X,y(),xe=[],$.add(ye.is(":visible")?null:ye).show(),U=!0,e(document).unbind("mouseup",C).mousemove(g).one("mouseup",x),$.unbind("mousemove",m),o.onSelectStart(t,l())}function C(){e(document).unbind("mousemove",S),$.add(ye).hide(),fe={x1:0,y1:0,x2:0,y2:0,width:0,height:0},o.onSelectChange(t,fe),o.onSelectEnd(t,fe)}function z(t){return 1==t.which&&(h(),B=M=r(t),R=X=a(t),e(document).one("mousemove",S).one("mouseup",C),!1)}function W(){h(),u(!1),M=i(fe.x1),X=n(fe.y1),Q=i(fe.x2),Y=n(fe.y2)}function k(){A=!0,o.show&&(U=!0,h(),u(),$.add(ye).show()),$.add(ye).css({visibility:""})}var A,H,P,N,O,K,I,E,T,j,L,B,R,q,D,M,Q,X,Y,F,G,J,U,V,Z=e(t),$=e("<div />"),_=e("<div />"),ee=e("<div />"),te=e("<div />"),oe=e("<div />"),ie=e("<div />"),ne=e("<div />"),se=e("<div />"),de=e([]),re=[],ae=Math,le=0,ce="absolute",he=1,ue=1,me=10,xe=[],pe=0,be=1,fe={x1:0,y1:0,x2:0,y2:0,width:0,height:0},ye=oe.add(ie).add(ne).add(se),ge=function(e){var t,i,n=o.keys,r=e.keyCode||e.which;if(t=isNaN(n.alt)||!e.altKey&&!e.originalEvent.altKey?!isNaN(n.ctrl)&&e.ctrlKey?n.ctrl:!isNaN(n.shift)&&e.shiftKey?n.shift:isNaN(n.arrows)?10:n.arrows:n.alt,"resize"==n.arrows||"resize"==n.shift&&e.shiftKey||"resize"==n.ctrl&&e.ctrlKey||"resize"==n.alt&&(e.altKey||e.originalEvent.altKey)){switch(r){case 37:t=-t;case 39:i=ae.max(M,Q),M=ae.min(M,Q),Q=ae.max(i+t,M),D&&f();break;case 38:t=-t;case 40:i=ae.max(X,Y),X=ae.min(X,Y),Y=ae.max(i+t,X),D&&b();break;default:return}y()}else switch(M=ae.min(M,Q),X=ae.min(X,Y),r){case 37:w(ae.max(M-t,N),X);break;case 38:w(M,ae.max(X-t,O));break;case 39:w(M+ae.min(t,I-s(Q)),X);break;case 40:w(M,X+ae.min(t,E-d(Y)));break;default:return}return!1};this.setOptions=function(s){if(s.parent&&(T=e(s.parent)).append($.add(ye)),h(),c(),null!=s.x1&&(fe={x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2},s.show=!s.hide,M=i(fe.x1),X=n(fe.y1),Q=i(fe.x2),Y=n(fe.y2),fe.width=Q-M,fe.height=Y-X),null!=s.handles){for(de.remove(),de=e(re=[]),V=s.handles?"corners"==s.handles?4:8:0;V--;)de=de.add(re[V]=e("<div />"));P=4+o.borderWidth,de.css({position:"absolute",borderWidth:o.borderWidth+"px",borderStyle:"solid",borderColor:o.borderColor1,opacity:o.borderOpacity,backgroundColor:o.borderColor2,width:P+"px",height:P+"px",fontSize:"0px",zIndex:le>0?le+1:"1"}).addClass(o.classPrefix+"-handle"),P+=2*o.borderWidth}u(),o=e.extend(o,s),o.onSelectBegin(t,fe),(o.imageWidth||o.imageHeight)&&(he=(parseInt(o.imageWidth)||I)/I,ue=(parseInt(o.imageHeight)||E)/E),s.keys&&(o.keys=e.extend({shift:1,ctrl:"resize"},s.keys===!0?{}:s.keys)),ye.addClass(o.classPrefix+"-outer"),_.addClass(o.classPrefix+"-selection"),ee.addClass(o.classPrefix+"-border1"),te.addClass(o.classPrefix+"-border2"),$.add(_).add(ee).add(te).css({borderWidth:o.borderWidth+"px"}),_.css({backgroundColor:o.selectionColor,opacity:o.selectionOpacity}),ee.css({borderStyle:"solid",borderColor:o.borderColor1}),te.css({borderStyle:"dashed",borderColor:o.borderColor2}),ee.add(te).css({opacity:o.borderOpacity}),ye.css({opacity:o.outerOpacity,backgroundColor:o.outerColor}),$.append(_.add(ee).add(te).add(de).add(H)),s.hide?$.add(ye).hide():s.show&&A&&(U=!0,u(),$.add(ye).show()),D=o.aspectRatio&&(q=o.aspectRatio.split(/:/))?q[0]/q[1]:null,D&&(o.minWidth?o.minHeight=parseInt(o.minWidth/D):o.minHeight&&(o.minWidth=parseInt(o.minHeight*D))),o.disable||o.enable===!1?($.unbind("mousemove",m).unbind("mousedown",p),Z.add(ye).unbind("mousedown",z),e(window).unbind("resize",W),Z.add(Z.parents()).unbind("scroll",W)):(o.enable||o.disable===!1)&&((o.resizable||o.movable)&&$.mousemove(m).mousedown(p),o.persistent||Z.add(ye).mousedown(z),e(window).resize(W),Z.add(Z.parents()).scroll(W)),o.enable=o.disable=void 0},e.browser.msie&&Z.attr("unselectable","on"),e.imgAreaSelect.keyPress=e.browser.msie||e.browser.safari?"keydown":"keypress",e.browser.opera&&(H=e('<div style="width: 100%; height: 100%; position: absolute;" />')).css({zIndex:le>0?le+2:"2"}),this.setOptions(o=e.extend({borderColor1:"#000",borderColor2:"#fff",borderWidth:1,borderOpacity:.5,classPrefix:"imgareaselect",movable:!0,resizable:!0,selectionColor:"#fff",selectionOpacity:0,outerColor:"#000",outerOpacity:.4,parent:"body",onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){},onSelectBegin:function(){}},o)),$.add(ye).css({visibility:"hidden",position:ce,overflow:"hidden",zIndex:le>0?le:"0"}),_.css({borderStyle:"solid"}),$.css({position:ce,zIndex:le>0?le+2:"2"}),_.add(ee).add(te).css({position:"absolute"}),t.complete||"complete"==t.readyState||!Z.is("img")?k():Z.one("load",k)},e.fn.imgAreaSelect=function(t){return t=t||{},this.each(function(){e(this).data("imgAreaSelect")?e(this).data("imgAreaSelect").setOptions(t):(void 0===t.enable&&void 0===t.disable&&(t.enable=!0),e(this).data("imgAreaSelect",new e.imgAreaSelect.init(this,t)))}),this}}(jQuery);
